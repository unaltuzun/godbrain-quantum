# ==============================================================================
# GODBRAIN QUANTUM - Complete 24/7 Kubernetes Deployment
# ==============================================================================
# Full system deployment including:
# 1. VOLTRAN (Trading Engine - agg.py)
# 2. Genetics Lab (DNA Evolution)  
# 3. Dashboard + Seraph AI
# 4. Market Feed
# 5. Redis
# ==============================================================================

---
# Namespace
apiVersion: v1
kind: Namespace
metadata:
  name: godbrain
  labels:
    app: godbrain

---
# ==============================================================================
# REDIS - State Management
# ==============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: godbrain
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        command: ["redis-server", "--requirepass", "$(REDIS_PASSWORD)"]
        ports:
        - containerPort: 6379
        env:
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: godbrain-secrets
              key: REDIS_PASS
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        volumeMounts:
        - name: redis-data
          mountPath: /data
      volumes:
      - name: redis-data
        emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: godbrain
spec:
  selector:
    app: redis
  ports:
  - port: 6379
    targetPort: 6379

---
# ==============================================================================
# VOLTRAN - Main Trading Engine (agg.py)
# ==============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: voltran
  namespace: godbrain
  labels:
    app: godbrain
    component: voltran
spec:
  replicas: 1
  selector:
    matchLabels:
      app: godbrain
      component: voltran
  template:
    metadata:
      labels:
        app: godbrain
        component: voltran
    spec:
      containers:
      - name: voltran
        image: us-central1-docker.pkg.dev/project-9ad1ce66-06b2-4a7f-bad/godbrain/voltran:latest
        imagePullPolicy: Always
        env:
        # OKX API
        - name: OKX_API_KEY
          valueFrom:
            secretKeyRef:
              name: godbrain-secrets
              key: OKX_API_KEY
        - name: OKX_API_SECRET
          valueFrom:
            secretKeyRef:
              name: godbrain-secrets
              key: OKX_API_SECRET
        - name: OKX_API_PASSPHRASE
          valueFrom:
            secretKeyRef:
              name: godbrain-secrets
              key: OKX_API_PASSPHRASE
        # Redis
        - name: REDIS_HOST
          value: "redis.godbrain.svc.cluster.local"
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_PASS
          valueFrom:
            secretKeyRef:
              name: godbrain-secrets
              key: REDIS_PASS
        - name: GENETICS_REDIS_HOST
          value: "redis.godbrain.svc.cluster.local"
        # Trading Config
        - name: SYMBOLS
          value: "DOGE/USDT:USDT,XRP/USDT:USDT"
        - name: EQUITY_FRACTION
          value: "0.9"
        - name: APEX_LIVE
          value: "true"
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        volumeMounts:
        - name: agg-code
          mountPath: /app/agg.py
          subPath: agg.py
        - name: agg-code
          mountPath: /app/config_center.py
          subPath: config_center.py
        - name: agg-code
          mountPath: /app/signals/harvester.py
          subPath: harvester.py
        - name: agg-code
          mountPath: /app/execution/executor.py
          subPath: executor.py
        - name: edge-ai-code
          mountPath: /app/edge_ai/__init__.py
          subPath: __init__.py
        - name: edge-ai-code
          mountPath: /app/edge_ai/inference.py
          subPath: inference.py
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
          failureThreshold: 3
      volumes:
      - name: agg-code
        configMap:
          name: voltran-agg-code
      - name: edge-ai-code
        configMap:
          name: voltran-edge-ai-pkg

---
# ==============================================================================
# GENETICS LAB - DNA Evolution Engine
# ==============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: genetics
  namespace: godbrain
  labels:
    app: godbrain
    component: genetics
spec:
  replicas: 1
  selector:
    matchLabels:
      app: godbrain
      component: genetics
  template:
    metadata:
      labels:
        app: godbrain
        component: genetics
    spec:
      containers:
      - name: genetics
        image: us-central1-docker.pkg.dev/project-9ad1ce66-06b2-4a7f-bad/godbrain/genetics:latest
        imagePullPolicy: Always
        env:
        - name: REDIS_HOST
          value: "redis.godbrain.svc.cluster.local"
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_PASS
          valueFrom:
            secretKeyRef:
              name: godbrain-secrets
              key: REDIS_PASS
        - name: GENETICS_REDIS_HOST
          value: "redis.godbrain.svc.cluster.local"
        - name: EVOLUTION_INTERVAL
          value: "300"  # 5 minutes
        resources:
          requests:
            memory: "256Mi"
            cpu: "200m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - "pgrep -f 'blackjack' || exit 1"
          initialDelaySeconds: 60
          periodSeconds: 60

---
# ==============================================================================
# DASHBOARD + SERAPH AI
# ==============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dashboard
  namespace: godbrain
  labels:
    app: godbrain
    component: dashboard
spec:
  replicas: 1
  selector:
    matchLabels:
      app: godbrain
      component: dashboard
  template:
    metadata:
      labels:
        app: godbrain
        component: dashboard
    spec:
      containers:
      - name: dashboard
        image: us-central1-docker.pkg.dev/project-9ad1ce66-06b2-4a7f-bad/godbrain/dashboard:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 8000
        env:
        - name: PORT
          value: "8000"
        - name: REDIS_HOST
          value: "redis.godbrain.svc.cluster.local"
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_PASS
          valueFrom:
            secretKeyRef:
              name: godbrain-secrets
              key: REDIS_PASS
        - name: ANTHROPIC_API_KEY
          valueFrom:
            secretKeyRef:
              name: godbrain-secrets
              key: ANTHROPIC_API_KEY
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: dashboard
  namespace: godbrain
spec:
  type: LoadBalancer
  selector:
    app: godbrain
    component: dashboard
  ports:
  - port: 80
    targetPort: 8000

---
# ==============================================================================
# MARKET FEED - Price Streamer
# ==============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: market-feed
  namespace: godbrain
  labels:
    app: godbrain
    component: market-feed
spec:
  replicas: 1
  selector:
    matchLabels:
      app: godbrain
      component: market-feed
  template:
    metadata:
      labels:
        app: godbrain
        component: market-feed
    spec:
      containers:
      - name: market-feed
        image: us-central1-docker.pkg.dev/project-9ad1ce66-06b2-4a7f-bad/godbrain/market-feed:latest
        imagePullPolicy: Always
        env:
        - name: REDIS_HOST
          value: "redis.godbrain.svc.cluster.local"
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_PASS
          valueFrom:
            secretKeyRef:
              name: godbrain-secrets
              key: REDIS_PASS
        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "200m"

---
# ==============================================================================
# SERAPH EVOLUTION DAEMON
# ==============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: seraph-daemon
  namespace: godbrain
  labels:
    app: godbrain
    component: seraph-daemon
spec:
  replicas: 1
  selector:
    matchLabels:
      app: godbrain
      component: seraph-daemon
  template:
    metadata:
      labels:
        app: godbrain
        component: seraph-daemon
    spec:
      containers:
      - name: seraph-daemon
        image: us-central1-docker.pkg.dev/project-9ad1ce66-06b2-4a7f-bad/godbrain/dashboard:latest
        command: ["python", "-m", "seraph.evolution_daemon"]
        env:
        - name: REDIS_HOST
          value: "redis.godbrain.svc.cluster.local"
        - name: REDIS_PASS
          valueFrom:
            secretKeyRef:
              name: godbrain-secrets
              key: REDIS_PASS
        - name: ANTHROPIC_API_KEY
          valueFrom:
            secretKeyRef:
              name: godbrain-secrets
              key: ANTHROPIC_API_KEY
        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "200m"
