apiVersion: v1
kind: Secret
metadata:
  name: cloudflared-creds
  namespace: godbrain
type: Opaque
stringData:
  credentials.json: |
    {"AccountTag":"d5108427e61029ecce313ff4435fcfa6","TunnelSecret":"scS9sJWZ0xTWWkunT+IOHB7Z3l1GG/ib+2lkwpQQCPI=","TunnelID":"503759d7-854c-44a6-ae83-c63c3260c13a","Endpoint":""}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cloudflared-config
  namespace: godbrain
data:
  config.yaml: |
    tunnel: 503759d7-854c-44a6-ae83-c63c3260c13a
    credentials-file: /etc/cloudflared/creds/credentials.json
    metrics: 0.0.0.0:2000
    no-autoupdate: true
    ingress:
    - hostname: godbrain.org
      service: http://dashboard:8000
    - hostname: www.godbrain.org
      service: http://dashboard:8000
    - hostname: app.godbrain.org
      service: http://mobile-app:3000
    - hostname: api.godbrain.org
      service: http://mobile-api:8001
    - service: http_status:404

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cloudflared
  namespace: godbrain
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cloudflared
  template:
    metadata:
      labels:
        app: cloudflared
    spec:
      containers:
      - name: cloudflared
        image: cloudflare/cloudflared:latest
        args:
        - tunnel
        - --config
        - /etc/cloudflared/config/config.yaml
        - run
        livenessProbe:
          httpGet:
            path: /ready
            port: 2000
          failureThreshold: 1
          initialDelaySeconds: 10
          periodSeconds: 10
        volumeMounts:
        - name: config
          mountPath: /etc/cloudflared/config
          readOnly: true
        - name: creds
          mountPath: /etc/cloudflared/creds
          readOnly: true
      volumes:
      - name: config
        configMap:
          name: cloudflared-config
          items:
          - key: config.yaml
            path: config.yaml
      - name: creds
        secret:
          secretName: cloudflared-creds

---
# ==============================================================================
# MOBILE API (Python/Flask)
# ==============================================================================
---
# ==============================================================================
# MOBILE API (Python/Flask)
# ==============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mobile-api
  namespace: godbrain
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mobile-api
  template:
    metadata:
      labels:
        app: mobile-api
    spec:
      containers:
      - name: mobile-api
        image: python:3.11-slim
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "ðŸ“¦ Installing Dependencies..."
          pip install --no-cache-dir flask flask-cors redis requests
          echo "ðŸš€ Starting API..."
          python mobile_api.py
        ports:
        - containerPort: 8001
        env:
        - name: REDIS_HOST
          value: "redis.godbrain.svc.cluster.local"
        - name: REDIS_PORT
          value: "6379"
        - name: REDIS_PASS
          valueFrom:
            secretKeyRef:
              name: godbrain-secrets
              key: REDIS_PASS
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
        volumeMounts:
        - name: api-code
          mountPath: /app/mobile_api.py
          subPath: mobile_api.py
        - name: api-code
          mountPath: /app/config_center.py
          subPath: config_center.py
      volumes:
      - name: api-code
        configMap:
          name: mobile-api-code

---
apiVersion: v1
kind: Service
metadata:
  name: mobile-api
  namespace: godbrain
spec:
  selector:
    app: mobile-api
  ports:
  - port: 8001
    targetPort: 8001

---
# ==============================================================================
# MOBILE APP (Next.js - Dev Mode in Cloud)
# ==============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mobile-app
  namespace: godbrain
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mobile-app
  template:
    metadata:
      labels:
        app: mobile-app
    spec:
      containers:
      - name: mobile-app
        image: node:18-alpine
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "ðŸ“¦ Installing Dependencies..."
          # Install pnpm
          corepack enable && corepack prepare pnpm@latest --activate
          
          # Copy files from mount to writable dir (K8s mounts are read-only)
          cp -r /source/* /app/
          cd /app
          
          pnpm install
          
          echo "ðŸš€ Starting Next.js (Dev Mode for speed)..."
          # Using dev mode because 'build' takes too long/resource intensive for this pod
          # Good enough for single user personal app
          pnpm run dev -- -p 3000 -H 0.0.0.0
        ports:
        - containerPort: 3000
        env:
        - name: NEXT_PUBLIC_API_URL
          value: "https://api.godbrain.org"
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
        volumeMounts:
        - name: app-source
          mountPath: /source
      volumes:
      - name: app-source
        configMap:
          name: mobile-app-source 

---
apiVersion: v1
kind: Service
metadata:
  name: mobile-app
  namespace: godbrain
spec:
  selector:
    app: mobile-app
  ports:
  - port: 3000
    targetPort: 3000
