# ==============================================================================
# GODBRAIN QUANTUM - Full System Docker Compose
# ==============================================================================
# Services:
#   - redis: Central data store
#   - market-feed: OKX real-time price feed
#   - dashboard: Web UI + Seraph AI
#   - voltran: Main trading aggregator (agg.py)
#   - genetics: Blackjack/Roulette/Chaos Labs
#   - synthia: Autonomous healing system
# ==============================================================================
version: '3.8'

services:
  # ============================================================================
  # REDIS - Central Data Store
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: godbrain-redis
    ports:
      - "16379:6379"
    command: redis-server --requirepass ${REDIS_PASS:-voltran2024}
    volumes:
      - redis-data:/data
    networks:
      - godbrain-network
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "${REDIS_PASS:-voltran2024}", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 5

  # ============================================================================
  # MARKET FEED - OKX Real-time Price
  # ============================================================================
  market-feed:
    build:
      context: .
      dockerfile: Dockerfile.market-feed
    container_name: godbrain-market-feed
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASS=${REDIS_PASS:-voltran2024}
    restart: unless-stopped
    networks:
      - godbrain-network
    healthcheck:
      test: [ "CMD", "python", "-c", "import os; import signal; import sys; [os.kill(int(p), 0) for p in os.listdir('/proc') if p.isdigit() and 'python' in open(f'/proc/{p}/cmdline').read()] or sys.exit(1)" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================================================
  # DASHBOARD - Web UI + Seraph AI
  # ============================================================================
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: godbrain-dashboard
    ports:
      - "8000:8000"
    depends_on:
      redis:
        condition: service_healthy
      market-feed:
        condition: service_started
    environment:
      - PORT=8000
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASS=${REDIS_PASS:-voltran2024}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - SERAPH_MODEL=${SERAPH_MODEL:-claude-sonnet-4-5-20250929}
    restart: unless-stopped
    networks:
      - godbrain-network
    volumes:
      - ./seraph:/app/seraph
      - ./quantum_lab/wisdom:/app/quantum_lab/wisdom
      - ./discoveries:/app/discoveries
    healthcheck:
      test: [ "CMD", "python", "-c", "import socket; s=socket.socket(); s.connect(('localhost', 8000)); s.close()" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================================================
  # VOLTRAN - Main Trading Aggregator
  # ============================================================================
  voltran:
    build:
      context: .
      dockerfile: Dockerfile.voltran
    container_name: godbrain-voltran
    depends_on:
      redis:
        condition: service_healthy
      market-feed:
        condition: service_started
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASS=${REDIS_PASS:-voltran2024}
      - GENETICS_REDIS_HOST=redis
      - GENETICS_REDIS_PORT=6379
      - GENETICS_REDIS_PASSWORD=${REDIS_PASS:-voltran2024}
      - LABS_REDIS_HOST=redis
      - LABS_REDIS_PORT=6379
      - LABS_REDIS_PASSWORD=${REDIS_PASS:-voltran2024}
      - OKX_API_KEY=${OKX_API_KEY}
      - OKX_SECRET=${OKX_SECRET}
      - OKX_PASSWORD=${OKX_PASSWORD}
      - OKX_USE_DEMO=${OKX_USE_DEMO:-true}
      - GODBRAIN_ROOT=/app
    restart: unless-stopped
    networks:
      - godbrain-network
    volumes:
      - ./logs:/app/logs
      - ./config:/app/config
    healthcheck:
      test: [ "CMD", "python", "-c", "import os; import sys; [os.kill(int(p), 0) for p in os.listdir('/proc') if p.isdigit() and 'agg.py' in open(f'/proc/{p}/cmdline').read()] or sys.exit(1)" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # GENETICS LABS - Blackjack/Roulette/Chaos Evolution
  # ============================================================================
  genetics:
    build:
      context: .
      dockerfile: Dockerfile.genetics
    container_name: godbrain-genetics
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASS=${REDIS_PASS:-voltran2024}
    restart: unless-stopped
    networks:
      - godbrain-network
    healthcheck:
      test: [ "CMD", "python", "-c", "import os; import sys; [os.kill(int(p), 0) for p in os.listdir('/proc') if p.isdigit() and 'python' in open(f'/proc/{p}/cmdline').read()] or sys.exit(1)" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================================================
  # SENTINEL v2 - Autonomous System Guardian (Docker Auto-Healing)
  # ============================================================================
  sentinel:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: godbrain-sentinel
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASS=${REDIS_PASS:-voltran2024}
    command: [ "python", "-u", "core/sentinel_v2.py" ]
    restart: unless-stopped
    networks:
      - godbrain-network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: [ "CMD", "python", "-c", "import os; import sys; [os.kill(int(p), 0) for p in os.listdir('/proc') if p.isdigit() and 'sentinel_v2.py' in open(f'/proc/{p}/cmdline').read()] or sys.exit(1)" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================================================
  # DNA PUSHER - Auto sync Lab DNA to Trading (24/7)
  # ============================================================================
  dna-pusher:
    build:
      context: .
      dockerfile: Dockerfile.genetics
    container_name: godbrain-dna-pusher
    depends_on:
      redis:
        condition: service_healthy
      genetics:
        condition: service_started
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASS=${REDIS_PASS:-voltran2024}
    command: [ "python", "genetics/dna_pusher.py" ]
    restart: unless-stopped
    networks:
      - godbrain-network

  # ============================================================================
  # FEEDBACK LOOP - Backtest â†’ Genetics Learning
  # ============================================================================
  feedback-loop:
    build:
      context: .
      dockerfile: Dockerfile.genetics
    container_name: godbrain-feedback-loop
    depends_on:
      redis:
        condition: service_healthy
      genetics:
        condition: service_started
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASS=${REDIS_PASS:-voltran2024}
    command: [ "python", "genetics/feedback_loop.py", "--continuous", "--interval", "6" ]
    restart: unless-stopped
    networks:
      - godbrain-network
    volumes:
      - ./data:/app/data

  # ============================================================================
  # QUANTUM LAB - Multiverse Evolution Engine (Physics Lab)
  # ============================================================================
  quantum-lab:
    build:
      context: .
      dockerfile: Dockerfile.genetics
    container_name: godbrain-quantum-lab
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASS=${REDIS_PASS:-voltran2024}
      - PYTHONIOENCODING=utf-8
    command: [ "python", "quantum_lab/quantum_daemon.py" ]
    restart: unless-stopped
    networks:
      - godbrain-network
    volumes:
      - ./quantum_lab:/app/quantum_lab
      - ./data:/app/data
    healthcheck:
      test: [ "CMD", "python", "-c", "import os; exit(0)" ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # ANOMALY HUNTER - Nobel-worthy Discovery Detection
  # ============================================================================
  anomaly-hunter:
    build:
      context: .
      dockerfile: Dockerfile.genetics
    container_name: godbrain-anomaly-hunter
    depends_on:
      redis:
        condition: service_healthy
      quantum-lab:
        condition: service_started
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASS=${REDIS_PASS:-voltran2024}
      - PYTHONIOENCODING=utf-8
    command: [ "python", "-m", "anomaly_hunter.hunter", "--monitor" ]
    restart: unless-stopped
    networks:
      - godbrain-network
    volumes:
      - ./anomaly_hunter:/app/anomaly_hunter
      - ./discoveries:/app/discoveries
      - ./quantum_lab:/app/quantum_lab
      - ./data:/app/data

  # ============================================================================
  # QUANTUM GENESIS - IBM Quantum Evolution Lab
  # ============================================================================
  quantum-genesis:
    build:
      context: .
      dockerfile: Dockerfile.genetics
    container_name: godbrain-quantum-genesis
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASS=${REDIS_PASS:-voltran2024}
      - IBM_QUANTUM_TOKEN=${IBM_QUANTUM_TOKEN}
      - PYTHONIOENCODING=utf-8
    command: [ "python", "-m", "quantum_genesis.genesis_daemon", "--simulator", "--epochs", "0" ]
    restart: unless-stopped
    networks:
      - godbrain-network
    volumes:
      - ./quantum_genesis:/app/quantum_genesis
      - ./data:/app/data

volumes:
  redis-data:


networks:
  godbrain-network:
    driver: bridge
